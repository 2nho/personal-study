![image](https://github.com/2nho/personal-study/assets/97571604/3402fc5b-9808-4b9d-8308-5607d59acccc)  


A서버에서 B서버로 요청시 ip:포트번호 형태로 직접연결 하게 될 경우 wireshark 툴로 확인하면 두 ip사이에서 통신이 이루어진다.

하지만 nginx로 proxy_pass를 이용해 리버스 프록시를 사용했을 때 의문이 발생했다.   
아래의 스샷을 보면  
![image](https://github.com/2nho/personal-study/assets/97571604/a46bbf0e-61ad-4eef-867f-ced291a63c25)  

192.168.0.2(서버 사설ip)에서 112.216.24.XXX(192.168.0.2의 공인ip) 으로 요청을 보내는데   
처음생각으로는 맨위처럼 192.168.0.2:64416(아웃바운트포트) -> 112.216.24.XXX:36135(인바운드포트)로 보내게되면 
이렇게 112.216.24.XXX:36135 -> 192.168.0.2:64416 두 ip사이에서 통신이 이루어질 줄 알았지만  
실제 로그를 보면 중간에 192.168.0.1 게이트웨이 포트가 새로 나타났다.

이는 내부ip에서 내부ip의 공인ip로 요청이 이루어지면 공유기에서 *루프백 통신을 통해 통신이 외부로 나가지 않고 다시 내부로 돌려주는 인터페이스에 의해 발생한 현상이다. 
192.168.0.2에서 112.216.24.XXX(내부 ip의 공인ip)로 요청을 하면 루프백에 의해 공유기(192.168.0.1)가 중간에서 



#요약 

- 내컴퓨터에서 서버컴퓨터로 직접연결하면 192.168.0.1 이라는 게이트웨이가 안나타남 <> nginx 로 서버에서 서버 공인ip로 포워드시키면 192.168.0.1이 나타남   
- 공유기의 루프백기능으로서 내부ip를 가르키는 통신이 공유기를 나가지 않고 공유기(192.168.0.1)에서 요청을 받아서 처리 이후 원래의 ip(112.216.24.XXX)로 변환 후 응답값을 192.168.0.2에 돌려줌  
- proxy_pass에 url에 공인ip주소가 아닌 사설네트워크(내부망) ex)192.168.0.2 주소를 적어주면 192.168.0.1(즉 루프백)을 타지 않는다. 
- 도움되는 url : https://blog.minny.i234.me/?p=1182  
- 이해에 도움되는 이미지 :  
![image](https://github.com/2nho/personal-study/assets/97571604/62f87942-ae54-4a13-8233-081c85ecf792)

  
## 참고1

![image](https://github.com/2nho/personal-study/assets/97571604/4d4d4ae4-97ef-4fb9-8250-712793782008)

tomcat이나 nginx 초기 실행 시 방화벽 추가에 대해 묻는데 확인을 누를 경우 방화벽에 자동으로 해당 프로그램을 통한 포트는 전부 허용시키게 되어있다.  
(보안에 따라 해당 방화벽 설정 사용안함으로 설정 후 원하는 포트만 인바운드 규칙에 추가)


## 참고2  
192.168.0.1, 192.168.0.3 등 하고 192.168.0.2는 내부네트워크의 관계가 아닌 외부 네트워크 관계이다.  

![image](https://github.com/2nho/personal-study/assets/97571604/a92a7508-b6e4-4617-8c58-9a4178b4ff6b)

위처럼 원격ip에 허용해줘야 통신이 된다(당연히 같은 사설ip대역이라 같은 내부네트워크라고 생각했다.  
cmd 창에 netstat -ano 명령어를 쳐보면 내부ip 와 외부ip가 나뉘어지는데 192.168.0.1는 이때 외부ip로 표시된다.)

